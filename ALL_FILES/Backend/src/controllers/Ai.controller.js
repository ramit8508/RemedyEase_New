import axios from "axios";

export const getAIRecommendation = async (req, res) => {
  const { symptoms } = req.body;

  if (!symptoms || symptoms.trim().length === 0) {
    return res.status(400).json({ error: "Symptoms are required." });
  }

  const apiKey = process.env.GROQ_API_KEY; 
  if (!apiKey) {
    console.error("ERROR: GROQ_API_KEY is not set in the .env file.");
    return res.status(500).json({ error: "Server configuration error." });
  }

  try {
    
    const response = await axios.post(
      "https://api.groq.com/openai/v1/chat/completions",
      {
        messages: [
          {
            role: "user",
            content: `Suggest a safe home remedy for these symptoms: ${symptoms}`,
          },
        ],
        model: "llama-3.1-8b-instant",
      },
      {
        headers: {
          "Authorization": `Bearer ${apiKey}`,
          "Content-Type": "application/json",
        },
      }
    );

    // 4. Extract the remedy from the correct location in the response
    const remedy = response.data.choices[0]?.message?.content || "No remedy suggestion found.";

    // 5. Send the successful response back
    res.status(200).json({ recommendation: remedy.trim() });

  } catch (error) {
    // This will now give you a more detailed error message from the API
    console.error("Groq API Error:", error.response?.data || error.message);
    res.status(500).json({ error: "Failed to get AI recommendation." });
  }
};

export const analyzeSymptoms = async (req, res) => {
  const { symptoms } = req.body;

  if (!symptoms || symptoms.trim().length === 0) {
    return res.status(400).json({ error: "Symptoms are required." });
  }

  const apiKey = process.env.GROQ_API_KEY; 
  if (!apiKey) {
    console.error("ERROR: GROQ_API_KEY is not set in the .env file.");
    return res.status(500).json({ error: "Server configuration error." });
  }

  const prompt = `You are a medical AI assistant. Analyze the following symptoms and provide a structured response in JSON format.

Symptoms: ${symptoms}

Analyze the severity and provide response in this exact JSON structure:
{
  "severity": "mild" or "moderate" or "severe",
  "summary": "A brief 2-3 sentence summary of the condition",
  "doctorType": "Type of doctor specialist needed (only if moderate or severe)",
  "reason": "Why this specialist is recommended (only if moderate or severe)",
  "homeRemedies": "List of home remedies separated by newlines (only if mild)"
}

Severity Guidelines:
- "mild": Common conditions like mild cold, minor headache, slight fever (<100¬∞F), minor stomach upset
- "moderate": Persistent symptoms, moderate pain, fever 100-102¬∞F, symptoms lasting 3+ days
- "severe": High fever (>102¬∞F), severe pain, difficulty breathing, chest pain, severe bleeding, sudden vision changes

For mild cases, suggest 3-5 practical home remedies.
For moderate/severe cases, recommend the appropriate specialist (e.g., "General Physician", "Cardiologist", "Dermatologist", etc.)

Respond ONLY with valid JSON, no additional text.`;

  try {
    const response = await axios.post(
      "https://api.groq.com/openai/v1/chat/completions",
      {
        messages: [
          {
            role: "system",
            content: "You are a medical AI assistant. Always respond with valid JSON format."
          },
          {
            role: "user",
            content: prompt,
          },
        ],
        model: "llama-3.1-8b-instant",
        temperature: 0.3,
      },
      {
        headers: {
          "Authorization": `Bearer ${apiKey}`,
          "Content-Type": "application/json",
        },
      }
    );

    const aiResponse = response.data.choices[0]?.message?.content || "{}";
    
    try {
      // Try to parse the JSON response
      const analysis = JSON.parse(aiResponse);
      
      // Validate the response structure
      if (!analysis.severity || !analysis.summary) {
        throw new Error("Invalid response structure");
      }

      // Send the structured response
      res.status(200).json(analysis);
    } catch (parseError) {
      console.error("JSON Parse Error:", parseError);
      // Fallback response if JSON parsing fails
      res.status(200).json({
        severity: "moderate",
        summary: "Unable to fully analyze symptoms. Please consult with a healthcare professional for proper evaluation.",
        doctorType: "General Physician",
        reason: "A general physician can evaluate your symptoms and provide appropriate guidance or referral to a specialist if needed."
      });
    }

  } catch (error) {
    console.error("Groq API Error:", error.response?.data || error.message);
    res.status(500).json({ error: "Failed to analyze symptoms. Please try again." });
  }
};

// New interactive flow: ask follow-up questions (up to 3) before producing final analysis
export const interactiveSymptomFlow = async (req, res) => {
  const { symptoms, conversation = [], language = 'en-US' } = req.body;

  if (!symptoms || symptoms.trim().length === 0) {
    return res.status(400).json({ error: "Symptoms are required." });
  }

  const apiKey = process.env.GROQ_API_KEY;
  if (!apiKey) {
    console.error("ERROR: GROQ_API_KEY is not set in the .env file.");
    return res.status(500).json({ error: "Server configuration error." });
  }

  // Language mapping for instructions
  const languageNames = {
    'en-US': 'English',
    'en-GB': 'English',
    'hi-IN': 'Hindi',
    'es-ES': 'Spanish',
    'fr-FR': 'French',
    'de-DE': 'German',
    'pt-BR': 'Portuguese',
    'zh-CN': 'Chinese',
    'ja-JP': 'Japanese',
    'ar-SA': 'Arabic'
  };

  const targetLanguage = languageNames[language] || 'English';
  const languageInstruction = targetLanguage !== 'English' 
    ? `\n\nIMPORTANT: Respond in ${targetLanguage} language. All questions must be in ${targetLanguage}.`
    : '';

  try {
    // If we have fewer than 7 follow-up answers, ask the next clarifying question
    if (!Array.isArray(conversation) || conversation.length < 7) {
      const prevQA = (conversation || [])
        .map((qa, idx) => `Q${idx + 1}: ${qa.question} / A${idx + 1}: ${qa.answer}`)
        .join("\n");

      const questionNumber = conversation.length + 1;
      
      // Define structured question topics to ensure comprehensive assessment
      const questionGuidelines = [
        "duration - How long have these symptoms been present?",
        "severity - On a scale of 1-10, how severe is your discomfort?",
        "fever - Do you have a fever? If yes, what is your temperature?",
        "pain location - Where exactly do you feel the pain or discomfort?",
        "additional symptoms - Are you experiencing any other symptoms like nausea, dizziness, or fatigue?",
        "recent activities - Have you had any recent injuries, travel, or exposure to sick people?",
        "medical history - Do you have any pre-existing medical conditions or allergies?"
      ];

      const currentGuideline = questionGuidelines[conversation.length] || "overall feeling - How are you feeling overall right now?";

      const askPrompt = `You are a compassionate medical assistant collecting diagnostic information from a patient.

Initial symptoms reported: ${symptoms}

Previous conversation:
${prevQA || "None yet"}

This is question ${questionNumber} of 7. Focus on: ${currentGuideline}

Based on the patient's symptoms and previous answers, ask ONE clear, empathetic follow-up question that addresses the focus area above.
Keep the question conversational and easy to understand.${languageInstruction}
Return ONLY the question text, no additional commentary.`;

      const response = await axios.post(
        "https://api.groq.com/openai/v1/chat/completions",
        {
          messages: [
            { role: "system", content: `You are a compassionate medical assistant. Ask clear, empathetic questions to understand the patient's condition.${languageInstruction}` },
            { role: "user", content: askPrompt }
          ],
          model: "llama-3.1-8b-instant",
          temperature: 0.3,
        },
        {
          headers: {
            Authorization: `Bearer ${apiKey}`,
            "Content-Type": "application/json",
          },
        }
      );

      const nextQuestion = response.data.choices[0]?.message?.content?.trim() || "Can you tell me more about how you're feeling?";

      return res.status(200).json({ 
        nextQuestion, 
        finished: false,
        questionNumber,
        totalQuestions: 8,
        isOptional: false
      });
    }

    // After 7 questions, ask an optional summary question
    if (conversation.length === 7) {
      const optionalQuestions = {
        'English': "Thank you for providing all that information! üòä Is there anything else you'd like to add or any other detail that might help us understand your situation better? (Feel free to skip this if you've covered everything)",
        'Hindi': "‡§Ø‡§π ‡§∏‡§≠‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§¶‡•á‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üòä ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§ï‡•Å‡§õ ‡§î‡§∞ ‡§ú‡•ã‡§°‡§º‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç ‡§Ø‡§æ ‡§ï‡•ã‡§à ‡§Ö‡§®‡•ç‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§ú‡•ã ‡§π‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ï‡•ã ‡§¨‡•á‡§π‡§§‡§∞ ‡§¢‡§Ç‡§ó ‡§∏‡•á ‡§∏‡§Æ‡§ù‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à? (‡§Ø‡§¶‡§ø ‡§Ü‡§™‡§®‡•á ‡§∏‡§¨ ‡§ï‡•Å‡§õ ‡§ï‡§µ‡§∞ ‡§ï‡§∞ ‡§≤‡§ø‡§Ø‡§æ ‡§π‡•à ‡§§‡•ã ‡§á‡§∏‡•á ‡§õ‡•ã‡§°‡§º‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•ç‡§µ‡§§‡§Ç‡§§‡•ç‡§∞ ‡§Æ‡§π‡§∏‡•Ç‡§∏ ‡§ï‡§∞‡•á‡§Ç)",
        'Spanish': "¬°Gracias por proporcionar toda esa informaci√≥n! üòä ¬øHay algo m√°s que le gustar√≠a agregar o alg√∫n otro detalle que pueda ayudarnos a entender mejor su situaci√≥n? (Si√©ntase libre de omitir esto si ya ha cubierto todo)",
        'French': "Merci d'avoir fourni toutes ces informations ! üòä Y a-t-il autre chose que vous aimeriez ajouter ou tout autre d√©tail qui pourrait nous aider √† mieux comprendre votre situation ? (N'h√©sitez pas √† sauter ceci si vous avez tout couvert)",
        'German': "Vielen Dank f√ºr all diese Informationen! üòä Gibt es noch etwas, das Sie hinzuf√ºgen m√∂chten, oder irgendein anderes Detail, das uns helfen k√∂nnte, Ihre Situation besser zu verstehen? (Sie k√∂nnen dies gerne √ºberspringen, wenn Sie alles abgedeckt haben)",
        'Portuguese': "Obrigado por fornecer todas essas informa√ß√µes! üòä H√° mais alguma coisa que voc√™ gostaria de adicionar ou qualquer outro detalhe que possa nos ajudar a entender melhor sua situa√ß√£o? (Sinta-se √† vontade para pular isso se voc√™ j√° cobriu tudo)",
        'Chinese': "ÊÑüË∞¢ÊÇ®Êèê‰æõÊâÄÊúâËøô‰∫õ‰ø°ÊÅØÔºÅüòä ÊÇ®ËøòÊúâ‰ªÄ‰πàË¶ÅË°•ÂÖÖÁöÑÂêóÔºåÊàñËÄÖÊúâ‰ªª‰ΩïÂÖ∂‰ªñÁªÜËäÇÂèØ‰ª•Â∏ÆÂä©Êàë‰ª¨Êõ¥Â•ΩÂú∞‰∫ÜËß£ÊÇ®ÁöÑÊÉÖÂÜµÔºüÔºàÂ¶ÇÊûúÊÇ®Â∑≤ÁªèÊ∂µÁõñ‰∫ÜÊâÄÊúâÂÜÖÂÆπÔºåËØ∑ÈöèÊó∂Ë∑≥ËøáÔºâ",
        'Japanese': "„Åô„Åπ„Å¶„ÅÆÊÉÖÂ†±„ÇíÊèê‰æõ„Åó„Å¶„ÅÑ„Åü„Å†„Åç„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅüòä ‰ªñ„Å´ËøΩÂä†„Åó„Åü„ÅÑ„Åì„Å®„ÇÑ„ÄÅÁä∂Ê≥Å„Çí„Çà„ÇäËâØ„ÅèÁêÜËß£„Åô„Çã„ÅÆ„Å´ÂΩπÁ´ã„Å§Ë©≥Á¥∞„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºüÔºà„Åô„Åπ„Å¶„Ç´„Éê„Éº„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Åì„Çå„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ",
        'Arabic': "ÿ¥ŸÉÿ±ÿßŸã ŸÑŸÉ ÿπŸÑŸâ ÿ™ŸÇÿØŸäŸÖ ŸÉŸÑ Ÿáÿ∞Ÿá ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™! üòä ŸáŸÑ ŸáŸÜÿßŸÉ ÿ£Ÿä ÿ¥Ÿäÿ° ÿ¢ÿÆÿ± ÿ™ÿ±ŸäÿØ ÿ•ÿ∂ÿßŸÅÿ™Ÿá ÿ£Ÿà ÿ£Ÿä ÿ™ŸÅÿßÿµŸäŸÑ ÿ£ÿÆÿ±Ÿâ ŸÇÿØ ÿ™ÿ≥ÿßÿπÿØŸÜÿß ÿπŸÑŸâ ŸÅŸáŸÖ ÿ≠ÿßŸÑÿ™ŸÉ ÿ®ÿ¥ŸÉŸÑ ÿ£ŸÅÿ∂ŸÑÿü (ŸÑÿß ÿ™ÿ™ÿ±ÿØÿØ ŸÅŸä ÿ™ÿÆÿ∑Ÿä Ÿáÿ∞ÿß ÿ•ÿ∞ÿß ŸÉŸÜÿ™ ŸÇÿØ ÿ∫ÿ∑Ÿäÿ™ ŸÉŸÑ ÿ¥Ÿäÿ°)"
      };
      
      const optionalQuestion = optionalQuestions[targetLanguage] || optionalQuestions['English'];
      
      return res.status(200).json({ 
        nextQuestion: optionalQuestion, 
        finished: false,
        questionNumber: 8,
        totalQuestions: 8,
        isOptional: true
      });
    }

    // Otherwise, produce final structured analysis by reusing the analyzeSymptoms prompt but include follow-ups
    const combined = `${symptoms}\n\nFollow-up answers:\n${(conversation || [])
      .map((qa, i) => `${i + 1}. ${qa.question} -> ${qa.answer}`)
      .join("\n")}`;

    const prompt = `You are a medical AI assistant. Analyze the following symptoms and follow-up answers and provide a structured response in JSON format.

Symptoms and follow-ups: ${combined}

Analyze the severity and provide response in this exact JSON structure:
{
  "severity": "mild" or "moderate" or "severe",
  "summary": "A brief 2-3 sentence summary of the condition",
  "doctorType": "Type of doctor specialist needed (only if moderate or severe)",
  "reason": "Why this specialist is recommended (only if moderate or severe)",
  "homeRemedies": "List of home remedies separated by newlines (only if mild)"
}
${languageInstruction}

Respond ONLY with valid JSON, no additional text.`;

    const finalResp = await axios.post(
      "https://api.groq.com/openai/v1/chat/completions",
      {
        messages: [
          { role: "system", content: `You are a medical AI assistant. Always respond with valid JSON format.${languageInstruction}` },
          { role: "user", content: prompt },
        ],
        model: "llama-3.1-8b-instant",
        temperature: 0.3,
      },
      {
        headers: {
          Authorization: `Bearer ${apiKey}`,
          "Content-Type": "application/json",
        },
      }
    );

    const aiResponse = finalResp.data.choices[0]?.message?.content || "{}";

    try {
      const analysis = JSON.parse(aiResponse);
      if (!analysis.severity || !analysis.summary) {
        throw new Error("Invalid response structure");
      }
      return res.status(200).json({ analysis, finished: true });
    } catch (parseError) {
      console.error("JSON Parse Error (interactive):", parseError);
      return res.status(200).json({ analysis: {
        severity: "moderate",
        summary: "Unable to fully analyze symptoms after follow-ups. Please consult a healthcare professional.",
        doctorType: "General Physician",
        reason: "A general physician can evaluate your symptoms and provide appropriate guidance or referral.",
      }, finished: true });
    }

  } catch (error) {
    console.error("Groq API Error (interactive):", error.response?.data || error.message);
    res.status(500).json({ error: "Failed to run interactive symptom flow. Please try again." });
  }
};